<!DOCTYPE html>
<html>
<head>
    <title>Guess the Song</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #222;
            color: #eee;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        #content {
            display: flex;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* Disable interaction until access is granted */
        }
        
        .access-granted {
            opacity: 1;
            pointer-events: auto;
        }

        #dvd-logo {
            position: absolute;
            width: 200px;
            height: auto;
            z-index: 1;
            pointer-events: none;
        }

        #black-bar {
            background-color: black;
            width: 100%;
            height: 100px;
            position: absolute;
            bottom: 0;
            z-index: 2;
        }

        #player-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .player {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .player button {
            margin: 0 5px;
        }

        #player-container {
            width: 300px;
            margin: 20px;
            background: #333;
            padding: 10px;
            border-radius: 5px;
            display: none; /* Initially hidden */
            position: relative; /* Needed for absolute positioning of artwork */
        }

        #track-artwork {
            width: 150px;
            height: 150px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        #track-artwork img {
            width: 100%;
            height: 100%;
        }

        #search-results {
            margin-top: 20px;
        }

        .track-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
        }

        .play-btn {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        #spotify-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background-color: #333;
            overflow-y: auto;
            transition: transform 0.3s ease;
            transform: translateX(100%); /* Initially hidden */
        }

        #spotify-panel.open {
            transform: translateX(0);
        }
        .spotify-trigger{
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }


    </style>
</head>
<body>
    <div id="loading">Loading...</div>
    <div id="content">
        <div id="dvd-logo">
            <img src="dvd.png" alt="DVD Logo">
        </div>
        <div id="black-bar"></div>
        <input type="text" id="player-name" placeholder="Player Name">
        <button onclick="addPlayer()">Add Player</button>
        <ul id="player-list"></ul>
        <div>Total Score: <span id="total-value">0</span></div>
        <div id="player-container" class="hidden">
            <div id="track-artwork"></div>
            <div id="track-info">
                <h3 id="track-name"></h3>
                <p id="track-artist"></p>
            </div>
            <button id="play-button" onclick="togglePlay()">▶</button>
            <button onclick="previousTrack()">Previous</button>
            <button onclick="nextTrack()">Next</button>
        </div>
        <input type="text" id="search-query" placeholder="Search Spotify">
        <button onclick="searchSpotify(document.getElementById('search-query').value)">Search</button>
        <div id="search-results"></div>

        <button class="spotify-trigger" data-spotify-uri="spotify:track:7ouMYWpwJ422jRcDASZB7P">Play Song 1</button>
        <button class="spotify-trigger" data-spotify-uri="spotify:track:6f1mQ9aO0bG8yL72P8d0wQ">Play Song 2</button>
    <button onclick="toggleSpotifyPanel()">Toggle Spotify Panel</button>

    </div>


    <div id="spotify-panel">
        <button onclick="logout()">Logout</button>
        <div class="login-message">Connect your Spotify account to access music</div>
        <a href="#" class="spotify-login-btn">Connect with Spotify</a>
    </div>

    <script defer src="https://sdk.scdn.co/spotify-player.js" integrity="sha384-0cZF2Y+RTJEhXHQV7QnZqgRMKvKHkwhU+su2pF9QqGrYg9IhpAIXXSlKXhbYFzEO" crossorigin="anonymous"></script>
    <script>
        let spotifyToken;
        let isAuthenticated = false;

        //Handle Spotify Callback
        function handleSpotifyCallback(e){
            if(e.location.hash){
                const token = e.location.hash.substring(14,e.location.hash.length -1);
                localStorage.setItem('spotify_token', token)
                isAuthenticated = true;
                window.location.reload(); //Refresh the page after login
            }
        }

        window.onSpotifyWebPlaybackSDKReady = () => {
            const token = localStorage.getItem('spotify_token');
            if (!token) return;
            spotifyToken = token;

            player = new Spotify.Player({
                name: 'Guess the Song Web Player',
                getOAuthToken: cb => { cb(spotifyToken); },
                volume: 0.5
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                deviceId = device_id;
                document.getElementById('player-container').classList.remove('hidden');
            });

            player.addListener('player_state_changed', state => {
                if (!state) return;

                const currentTrack = state.track_window.current_track;
                const artworkElement = document.getElementById('track-artwork');
                if (currentTrack && currentTrack.album.images[0]) {
                    artworkElement.innerHTML = `<img src="${currentTrack.album.images[0].url}" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    artworkElement.innerHTML = '?';
                }
                document.getElementById('track-name').textContent = currentTrack.name;
                document.getElementById('track-artist').textContent = currentTrack.artists[0].name;

                isPlaying = !state.paused;
                document.getElementById('play-button').textContent = isPlaying ? '⏸' : '▶';
            });

            player.connect();
        };

        function togglePlay() {
            if (!player) return;
            player.togglePlay();
        }

        function nextTrack() {
            if (!player) return;
            player.nextTrack();
        }

        function previousTrack() {
            if (!player) return;
            player.previousTrack();
        }

        async function searchSpotify(query) {
            if (!query || !spotifyToken) return;

            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${spotifyToken}`
                    }
                });

                const data = await response.json();
                const resultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = data.tracks.items.map(track => `
                    <div class="track-item" onclick="showTrackInfo(${JSON.stringify(track).replace(/"/g, '&quot;')})">
                        <img src="${track.album.images[2].url}" style="width: 40px; height: 40px;">
                        <div>
                            <div>${track.name}</div>
                            <div style="font-size: 0.8em; color: #888;">${track.artists[0].name}</div>
                        </div>
                        <button class="play-btn" onclick="event.stopPropagation(); playTrack('${track.uri}', '${deviceId}')">▶</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function playTrack(uri, deviceId) {
            if (!deviceId || !spotifyToken) {
                console.error('Device ID or token missing');
                return;
            }

            try {
                const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${spotifyToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: [uri]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                console.log('Playback started successfully');
            } catch (error) {
                console.error('Playback error:', error);
                alert('Error playing track. Please try again.');
            }
        }

        function showTrackInfo(track) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(25, 25, 25, 0.95);
                padding: 20px;
                border-radius: 10px;
                z-index: 1002;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            `;

            const releaseDate = new Date(track.album.release_date).toLocaleDateString();
            const artists = track.artists.map(artist => artist.name).join(', ');

            modal.innerHTML = `
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <img src="${track.album.images[1].url}" style="width: 150px; height: 150px; border-radius: 5px;">
                    <div>
                        <h2 style="color: white; margin: 0 0 10px 0;">${track.name}</h2>
                        <p style="color: #b3b3b3; margin: 5px 0;">Artist: ${artists}</p>
                        <p style="color: #b3b3b3; margin: 5px 0;">Album: ${track.album.name}</p>
                        <p style="color: #b3b3b3; margin: 5px 0;">Release Date: ${releaseDate}</p>
                        <p style="color: #b3b3b3; margin: 5px 0;">Duration: ${Math.floor(track.duration_ms/60000)}:${((track.duration_ms%60000)/1000).toFixed(0).padStart(2,'0')}</p>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="
                    background: #1DB954;
                    border: none;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    cursor: pointer;
                    display: block;
                    margin: 0 auto;
                ">Close</button>
            `;

            document.body.appendChild(modal);
        }

        function logout() {
            localStorage.removeItem('spotify_token');
            isAuthenticated = false;
            document.querySelector('.login-message').textContent = 'Connect your Spotify account to access music';
            document.querySelector('.spotify-login-btn').style.display = 'block';
            document.getElementById('player-container').classList.add('hidden');
            if (player) {
                player.disconnect();
            }
        }

        window.onload = () => {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }

            // If authenticated, hide login button
            if (localStorage.getItem('spotify_token')) {
                const loginBtn = document.querySelector('.spotify-login-btn');
                const loginMsg = document.querySelector('.login-message');

                if (loginBtn) {
                    loginBtn.style.display = 'none';
                }
                if (loginMsg) {
                    loginMsg.textContent = 'Connected to Spotify';
                }
            }
        };


        // --- PLAYER AND SCORE FUNCTIONALITY ---
// Modify the total score
function modifyTotal(amount) {
    totalScore += amount;
    totalScoreElement.textContent = totalScore;
}

// Modified Add Player Function
function addPlayer() {
    const playerNameInput = document.getElementById('player-name');
    const playerName = playerNameInput.value.trim();
    if (playerName) {
        // Create player entry with score adjustment buttons
        const li = document.createElement('li');
        li.classList.add('player');
        li.innerHTML = `
            <button onclick="removePlayer(this)">❌</button>
            <span>${playerName}</span>
            <div>
                <button onclick="modifyPlayerScore('${playerName}', 1)">+</button>
                <span id="score-${playerName}">0</span>
                <button onclick="modifyPlayerScore('${playerName}', -1)">-</button>
            </div>
        `;
        playerList.appendChild(li);
        playerNameInput.value = ''; // Clear input after adding player
    }
}

// Remove player function
function removePlayer(button) {
    const playerItem = button.parentElement;
    playerItem.remove(); // This removes the player list item
}

// Modify player score function
function modifyPlayerScore(playerName, value) {
    const scoreElement = document.getElementById(`score-${playerName}`);
    if (scoreElement) {
        let currentScore = parseInt(scoreElement.innerText);
        currentScore += value;
        scoreElement.innerText = currentScore;
    }
}


// Modify player score function
function modifyPlayerScore(playerName, value) {
    const scoreElement = document.getElementById(`score-${playerName}`);
    let currentScore = parseInt(scoreElement.innerText);
    currentScore += value;
    scoreElement.innerText = currentScore;
}


    // No IP checking or access control needed
    function toggleSpotifyPanel() {
        const panel = document.getElementById('spotify-panel');
        panel.classList.toggle('open');
    }

    let player;
    let deviceId;
    let isPlaying = false;

    load
    window.addEventListener('load', handleSpotifyCallback);
    // Initialize Spotify embed
    window.onSpotifyIframeApiReady = (IFrameAPI) => {
        const element = document.getElementById('embed-iframe');
        const options = {
            width: '100%',
            height: '352',
            uri: 'spotify:playlist:37i9dQZF1DXcBWIGoYBM5M' // Example playlist - Today's Top Hits
        };
        const callback = (EmbedController) => {
            document.querySelectorAll('.spotify-trigger').forEach(button => {
                button.addEventListener('click', () => {
                    const songUri = button.getAttribute('data-spotify-uri');
                    if (songUri) {
                        EmbedController.loadUri(songUri);
                    }
                });
            });
        };
        IFrameAPI.createController(element, options, callback);
    };

    const playerList = document.getElementById('player-list');
    const totalScoreElement = document.getElementById('total-value');
    const dvdLogo = document.getElementById('dvd-logo');
    const blackBar = document.getElementById('black-bar');
    const content = document.getElementById('content');
    content.classList.add('access-granted'); // Enable interaction by default

    let totalScore = 0;
    let dx = 1.3;
    let dy = 1.1;

    // Start position
    let x = 100; // Starting X position
    let y = 100; // Starting Y position

    // Speed
    let speedX = dx;
    let speedY = dy;

    // Canvas dimensions
    const screenWidth = window.innerWidth;
    const screenHeight = window.innerHeight;

    // Get the height of the black bar
    const blackBarHeight = blackBar.offsetHeight;

    // Set initial position of the logo
    dvdLogo.style.left = x + 'px';
    dvdLogo.style.top = y + 'px';

    // Adjust logo size
    const logoWidth = dvdLogo.offsetWidth;
    const logoHeight = dvdLogo.offsetHeight;

    // The main animation loop
    function animate() {
        // Update position
        x += speedX;
        y += speedY;

        // Check for collision with right and left borders
        if (x + logoWidth > screenWidth || x < 0) {
            speedX = -speedX;  // Reverse horizontal direction
            if (x + logoWidth > screenWidth) {
                x = screenWidth - logoWidth;  // Correct position to prevent overshooting
            } else if (x < 0) {
                x = 0;  // Correct position to prevent overshooting
            }
        }

        // Check for collision with top border
        if (y < 0) {
            speedY = -speedY;  // Reverse vertical direction at the top border
            y = 0;  // Correct position to prevent overshooting
        }

        // Check for collision with bottom (black bar)
        if (y + logoHeight > screenHeight - blackBarHeight) {
            speedY = -speedY;  // Reverse vertical direction at the bottom
            y = screenHeight - blackBarHeight - logoHeight;  // Correct position to prevent overshooting
        }

        // Update the position of the logo
        dvdLogo.style.left = x + 'px';
        dvdLogo.style.top = y + 'px';

        // Continue animating
        requestAnimationFrame(animate);
    }

    // Start the animation
    // Start the animation
animate();
    </script>
</body>
</html>
